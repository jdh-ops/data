<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì—‘ì…€ íŒŒì¼ ì €ì¥ì†Œ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; padding: 20px; background: #f8f9fa; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .upload-card { border: 2px dashed #3498db; padding: 30px; text-align: center; border-radius: 10px; margin-bottom: 30px; background: #ebf5fb; }
        .file-list { list-style: none; padding: 0; }
        .file-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #eee; }
        .btn { padding: 8px 16px; border-radius: 5px; border: none; cursor: pointer; font-weight: bold; }
        .btn-primary { background: #3498db; color: white; }
        .btn-download { background: #2ecc71; color: white; text-decoration: none; font-size: 13px; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ“ í”„ë¡œì íŠ¸ ì—‘ì…€ ì €ì¥ì†Œ</h2>
    <p id="tableInfo" style="color: #666;"></p>

    <div class="upload-card">
        <input type="file" id="fileInput" accept=".xlsx, .xls, .csv">
        <button class="btn btn-primary" onclick="uploadFile()">íŒŒì¼ ì„œë²„ì— ì˜¬ë¦¬ê¸°</button>
        <p id="status" style="margin-top: 10px; font-size: 14px;"></p>
    </div>

    <h3>ë‚´ì—­ ëª©ë¡</h3>
    <ul id="fileList" class="file-list">
        <li>íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li>
    </ul>
</div>

<script>
    const SUPABASE_URL = 'https://vszejvzjznhmlqddltwt.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZzemVqdnpqem5obWxxZGRsdHd0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY2MjUzMjQsImV4cCI6MjA4MjIwMTMyNH0.O0uFN0J3nMHvlMu1wS4fbumngFTRog6PkHruK6CWE7w';
    const _supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const urlParams = new URLSearchParams(window.location.search);
    const tableName = urlParams.get('table') || 'default'; // í‚¤ì›Œë“œì— ë”°ë¥¸ êµ¬ë¶„ìš©

    document.getElementById('tableInfo').innerText = `í˜„ì¬ ìœ„ì¹˜: ${tableName} í´ë”`;

    // 1. íŒŒì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    async function listFiles() {
        const { data, error } = await _supabase.storage
            .from('excel-files')
            .list(tableName + '/'); // í‚¤ì›Œë“œë³„ë¡œ í´ë”ë¥¼ ë‚˜ëˆ ì„œ ê´€ë¦¬

        if (error) {
            console.error(error);
            return;
        }

        const listEl = document.getElementById('fileList');
        if (data.length === 0) {
            listEl.innerHTML = "<li>ì—…ë¡œë“œëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</li>";
            return;
        }

        listEl.innerHTML = data.map(file => {
            // íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì£¼ì†Œ ìƒì„±
            const { data: urlData } = _supabase.storage.from('excel-files').getPublicUrl(`${tableName}/${file.name}`);
            return `
                <li class="file-item">
                    <span>${file.name}</span>
                    <a href="${urlData.publicUrl}" class="btn btn-download" download>ë‹¤ìš´ë¡œë“œ</a>
                </li>
            `;
        }).join('');
    }

    // 2. íŒŒì¼ ì—…ë¡œë“œí•˜ê¸°
    async function uploadFile() {
        const fileInput = document.getElementById('fileInput');
        const status = document.getElementById('status');
        
        if (!fileInput.files[0]) {
            alert("íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
            return;
        }

        const file = fileInput.files[0];
        const filePath = `${tableName}/${file.name}`; // í´ë”ëª…/íŒŒì¼ëª… êµ¬ì¡°

        status.innerText = "ì—…ë¡œë“œ ì¤‘...";

        const { data, error } = await _supabase.storage
            .from('excel-files')
            .upload(filePath, file, { upsert: true }); // ë™ì¼ ì´ë¦„ ìˆìœ¼ë©´ ë®ì–´ì“°ê¸°

        if (error) {
            status.innerText = "âŒ ì‹¤íŒ¨: " + error.message;
        } else {
            status.innerText = "âœ… ì—…ë¡œë“œ ì™„ë£Œ!";
            listFiles(); // ëª©ë¡ ê°±ì‹ 
        }
    }

    // ì´ˆê¸° ë¡œë“œ
    listFiles();
</script>
</body>
</html>

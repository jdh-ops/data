<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ê´€ë¦¬ ì‹œìŠ¤í…œ - ë°ì´í„° ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --sidebar-width: 260px; --primary-color: #3498db; --bg-color: #f8f9fa; }
        body { font-family: 'Malgun Gothic', sans-serif; margin: 0; display: flex; height: 100vh; background: var(--bg-color); color: #333; }

        /* ì‚¬ì´ë“œë°” */
        .sidebar { width: var(--sidebar-width); background: #2c3e50; color: white; display: flex; flex-direction: column; box-shadow: 2px 0 5px rgba(0,0,0,0.1); }
        .sidebar-header { padding: 30px 20px; font-size: 1.3rem; font-weight: bold; border-bottom: 1px solid #3e4f5f; text-align: center; color: #ecf0f1; }
        .sidebar-menu { flex: 1; padding: 20px 0; }
        .menu-item { padding: 15px 25px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; font-size: 15px; }
        .menu-item:hover { background: #34495e; }
        .menu-item.active { background: var(--primary-color); color: white; border-right: 5px solid #fff; }

        /* ë©”ì¸ ì½˜í…ì¸  */
        .main-content { flex: 1; overflow-y: auto; padding: 40px; }
        .content-section { display: none; }
        .content-section.active { display: block; animation: fadeIn 0.4s ease-out; }

        /* ì—…ë¡œë“œ ì¹´ë“œ ë° ë“œë˜ê·¸ì•¤ë“œë */
        .upload-card { 
            background: white; padding: 50px; border-radius: 15px; 
            border: 2px dashed #cbd5e0; text-align: center; 
            transition: all 0.3s; cursor: pointer; margin-bottom: 30px;
        }
        .upload-card.drag-over { border-color: var(--primary-color); background: #ebf5fb; transform: scale(1.01); }
        .file-list { background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); overflow: hidden; }
        .file-row { display: flex; justify-content: space-between; padding: 18px 25px; border-bottom: 1px solid #f1f1f1; align-items: center; }
        .file-row:last-child { border-bottom: none; }
        
        .btn-primary { padding: 12px 25px; background: var(--primary-color); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-select { padding: 8px 15px; background: #edf2f7; border: 1px solid #e2e8f0; border-radius: 5px; cursor: pointer; margin-top: 10px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-header" id="projectTitle">PROJECT</div>
        <div class="sidebar-menu">
            <div class="menu-item active" onclick="showSection('dashboard')">ğŸ  ëŒ€ì‹œë³´ë“œ</div>
            <div class="menu-item" onclick="showSection('upload')">ğŸ“¤ íŒŒì¼ ì—…ë¡œë“œ</div>
            <div class="menu-item" onclick="showSection('settings')">âš™ï¸ ì„¤ì •</div>
        </div>
    </div>

    <div class="main-content">
        <div id="dashboard" class="content-section active">
            <h2 id="dashHeader">ëŒ€ì‹œë³´ë“œ</h2>
            <div style="background: white; padding: 20px; border-radius: 10px;">
                <p>í™˜ì˜í•©ë‹ˆë‹¤! ì™¼ìª½ ë©”ë‰´ë¥¼ í†µí•´ íŒŒì¼ì„ ê´€ë¦¬í•˜ì„¸ìš”.</p>
            </div>
        </div>

        <div id="upload" class="content-section">
            <h2>íŒŒì¼ ì—…ë¡œë“œ</h2>
            <div id="dropZone" class="upload-card" 
                 ondragover="handleDragOver(event)" 
                 ondragleave="handleDragLeave(event)" 
                 ondrop="handleDrop(event)">
                <p id="dropText" style="font-size: 18px; color: #4a5568;">ğŸ“¤ íŒŒì¼ì„ ì—¬ê¸°ë¡œ ëŒì–´ë‹¤ ë†“ìœ¼ì„¸ìš”</p>
                <input type="file" id="fileInput" accept=".xlsx, .xls, .csv" style="display: none;" onchange="handleFileSelect(event)">
                <button onclick="document.getElementById('fileInput').click()" class="btn-select">ë˜ëŠ” íŒŒì¼ ì„ íƒ</button>
                <p id="selectedFileName" style="margin-top: 15px; font-weight: bold; color: #3498db;"></p>
                <button id="uploadBtn" onclick="uploadFile()" class="btn-primary" style="display: none; margin: 20px auto;">ì„œë²„ë¡œ ì „ì†¡ ì‹œì‘</button>
                <p id="uploadStatus" style="margin-top:10px; font-size:14px; color: #718096;"></p>
            </div>

            <h3>ğŸ“ ì €ì¥ëœ íŒŒì¼ ë‚´ì—­</h3>
            <div id="fileList" class="file-list">
                <p style="padding: 20px; color: #a0aec0;">íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
            </div>
        </div>

        <div id="settings" class="content-section">
            <h2>ì„¤ì •</h2>
            <div style="background: white; padding: 20px; border-radius: 10px;">
                <p>ì‹œìŠ¤í…œ ì•Œë¦¼ ë° ê³„ì • ì„¤ì •ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.</p>
            </div>
        </div>
    </div>

<script>
    // 1. Supabase ì´ˆê¸°í™”
    const SUPABASE_URL = 'https://vszejvzjznhmlqddltwt.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZzemVqdnpqem5obWxxZGRsdHd0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY2MjUzMjQsImV4cCI6MjA4MjIwMTMyNH0.O0uFN0J3nMHvlMu1wS4fbumngFTRog6PkHruK6CWE7w'; // eyJ...ë¡œ ì‹œì‘í•˜ëŠ” ê¸´ í‚¤ë¡œ êµì²´í•˜ì„¸ìš”!
    const _supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const urlParams = new URLSearchParams(window.location.search);
    const tableName = urlParams.get('table') || 'default';
    document.getElementById('projectTitle').innerText = tableName.toUpperCase();
    document.getElementById('dashHeader').innerText = `${tableName.toUpperCase()} ëŒ€ì‹œë³´ë“œ`;

    let selectedFile = null;

    // [ì¤‘ìš”] ì„¹ì…˜ ì „í™˜ í•¨ìˆ˜ (showSection is not defined ì—ëŸ¬ í•´ê²°)
    window.showSection = function(sectionId) {
        // ëª¨ë“  ì„¹ì…˜ ìˆ¨ê¸°ê¸°
        document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
        // ëª¨ë“  ë©”ë‰´ ì•„ì´í…œ í™œì„±í™” í•´ì œ
        document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
        
        // ëŒ€ìƒ ì„¹ì…˜ ë³´ì´ê¸°
        document.getElementById(sectionId).classList.add('active');
        
        // í´ë¦­ëœ ë©”ë‰´ í•˜ì´ë¼ì´íŠ¸ (ì´ë²¤íŠ¸ ëŒ€ìƒì„ ì°¾ì•„ í™œì„±í™”)
        const menuItems = document.querySelectorAll('.menu-item');
        menuItems.forEach(item => {
            if(item.innerText.includes(sectionId === 'dashboard' ? 'ëŒ€ì‹œë³´ë“œ' : sectionId === 'upload' ? 'ì—…ë¡œë“œ' : 'ì„¤ì •')) {
                item.classList.add('active');
            }
        });

        if(sectionId === 'upload') listFiles();
    }

    // --- ë“œë˜ê·¸ ì•¤ ë“œë ë¡œì§ ---
    function handleDragOver(e) { e.preventDefault(); document.getElementById('dropZone').classList.add('drag-over'); }
    function handleDragLeave(e) { e.preventDefault(); document.getElementById('dropZone').classList.remove('drag-over'); }
    function handleDrop(e) {
        e.preventDefault();
        document.getElementById('dropZone').classList.remove('drag-over');
        if (e.dataTransfer.files.length > 0) processFile(e.dataTransfer.files[0]);
    }
    function handleFileSelect(e) {
        if (e.target.files.length > 0) processFile(e.target.files[0]);
    }
    function processFile(file) {
        selectedFile = file;
        document.getElementById('selectedFileName').innerText = "ì„ íƒëœ íŒŒì¼: " + file.name;
        document.getElementById('uploadBtn').style.display = 'block';
        document.getElementById('dropText').innerText = "íŒŒì¼ì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤!";
    }

    // --- íŒŒì¼ ëª©ë¡ ë° ì—…ë¡œë“œ ë¡œì§ ---
    async function listFiles() {
        const listEl = document.getElementById('fileList');
        try {
            const { data, error } = await _supabase.storage.from('excel-files').list(tableName + '/');
            if (error) throw error;
            if (!data || data.length === 0) {
                listEl.innerHTML = "<p style='padding:20px; color:#a0aec0;'>ì—…ë¡œë“œëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
                return;
            }

            // ëª¨ë“  íŒŒì¼ì˜ ì›ë³¸ íŒŒì¼ëª…ì„ í•œ ë²ˆì— ì¡°íšŒ
            const safeFileNames = data
                .filter(f => f.name !== '.emptyFolder')
                .map(f => f.name);
            
            const { data: fileMappings } = await _supabase
                .from('file_names')
                .select('safe_file_name, original_file_name')
                .eq('table_name', tableName)
                .in('safe_file_name', safeFileNames);

            // ë§¤í•‘ ë°ì´í„°ë¥¼ ê°ì²´ë¡œ ë³€í™˜ (ë¹ ë¥¸ ì¡°íšŒë¥¼ ìœ„í•´)
            const nameMap = {};
            if (fileMappings) {
                fileMappings.forEach(m => {
                    nameMap[m.safe_file_name] = m.original_file_name;
                });
            }

            listEl.innerHTML = data.map(file => {
                if (file.name === '.emptyFolder') return '';

                // í…Œì´ë¸”ì—ì„œ ì›ë³¸ íŒŒì¼ëª… ê°€ì ¸ì˜¤ê¸°
                const displayName = nameMap[file.name] || file.name;
                
                // íŒŒì¼ëª…ì—ì„œ ë‚ ì§œ ì¶”ì¶œ (--YYYYMMDD í˜•ì‹)
                const dateMatch = displayName.match(/--(\d{8})(\.[^.]+)?$/);
                let displayText = displayName;
                let dateDisplay = '';
                
                if (dateMatch) {
                    // ë‚ ì§œ ë¶€ë¶„ ì¶”ì¶œ (YYYYMMDD)
                    const dateStr = dateMatch[1];
                    const year = dateStr.substring(0, 4);
                    const month = dateStr.substring(4, 6);
                    const day = dateStr.substring(6, 8);
                    dateDisplay = `${year}-${month}-${day}`;
                    
                    // í‘œì‹œìš© í…ìŠ¤íŠ¸: íŒŒì¼ëª…ê³¼ ë‚ ì§œë¥¼ ë¶„ë¦¬í•˜ì—¬ í‘œì‹œ
                    displayText = displayName.replace(/--\d{8}(?=\.[^.]+)?$/, '');
                }
                
                return `
                    <div class="file-row">
                        <span>ğŸ“„ ${displayText}${dateDisplay ? ` <span style="color:#718096; font-size:0.9em;">(${dateDisplay})</span>` : ''}</span>
                        <a href="#" onclick="downloadFile('${file.name}', ${JSON.stringify(displayName)}); return false;" style="color:#3498db; text-decoration:none; font-weight:bold;">ë‹¤ìš´ë¡œë“œ</a>
                    </div>
                `;
            }).join('');
        } catch (err) {
            listEl.innerHTML = `<p style="padding:20px; color:red;">ì—ëŸ¬: ${err.message}</p>`;
        }
    }

    async function uploadFile() {
        if (!selectedFile) return;
        const status = document.getElementById('uploadStatus');
        status.innerText = "ì„œë²„ë¡œ ì „ì†¡ ì¤‘...";

        const originalFileName = selectedFile.name;
        const fileExt = originalFileName.split('.').pop();
        const fileNameWithoutExt = originalFileName.substring(0, originalFileName.lastIndexOf('.'));

        // í˜„ì¬ ë‚ ì§œë¥¼ YYYYMMDD í˜•ì‹ìœ¼ë¡œ ìƒì„± (ì˜ˆ: 20251230)
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const dateStr = `${year}${month}${day}`;
        
        // ì›ë³¸ íŒŒì¼ëª…ì— ë‚ ì§œ ì¶”ê°€ (ì˜ˆ: íŒŒì¼ëª…--20251230.xlsx)
        const fileNameWithDate = `${fileNameWithoutExt}--${dateStr}.${fileExt}`;

        // [í•´ê²° í•µì‹¬] Supabase StorageëŠ” íŒŒì¼ ê²½ë¡œì— í•œê¸€, ê³µë°±, íŠ¹ìˆ˜ë¬¸ìê°€ ìˆìœ¼ë©´ Invalid key ì˜¤ë¥˜ ë°œìƒ
        // íŒŒì¼ëª…ì„ ì™„ì „íˆ ì•ˆì „í•œ ì˜ë¬¸/ìˆ«ì/ì–¸ë”ìŠ¤ì½”ì–´/í•˜ì´í”ˆìœ¼ë¡œë§Œ êµ¬ì„±
        // ì›ë³¸ íŒŒì¼ëª…ì€ ë³„ë„ í…Œì´ë¸”ì— ì €ì¥
        
        const timestamp = Date.now();
        const randomStr = Math.random().toString(36).substring(2, 8); // ëœë¤ ë¬¸ìì—´ ì¶”ê°€
        
        // ì•ˆì „í•œ íŒŒì¼ëª… ìƒì„±: ì˜ë¬¸, ìˆ«ì, ì–¸ë”ìŠ¤ì½”ì–´, í•˜ì´í”ˆë§Œ ì‚¬ìš©
        const safeFileName = `file_${timestamp}_${randomStr}.${fileExt}`;
        const filePath = `${tableName}/${safeFileName}`;

        try {
            const { data, error } = await _supabase.storage
                .from('excel-files')
                .upload(filePath, selectedFile, { 
                    upsert: true,
                    contentType: selectedFile.type
                });

            if (error) throw error;

            // ì›ë³¸ íŒŒì¼ëª…(ë‚ ì§œ í¬í•¨)ì„ í…Œì´ë¸”ì— ì €ì¥
            const { error: dbError } = await _supabase
                .from('file_names')
                .upsert({
                    table_name: tableName,
                    safe_file_name: safeFileName,
                    original_file_name: fileNameWithDate,
                    created_at: new Date().toISOString()
                }, {
                    onConflict: 'table_name,safe_file_name'
                });

            if (dbError) {
                console.error("íŒŒì¼ëª… ì €ì¥ ì—ëŸ¬:", dbError);
                // íŒŒì¼ëª… ì €ì¥ ì‹¤íŒ¨í•´ë„ ì—…ë¡œë“œëŠ” ì„±ê³µí–ˆìœ¼ë¯€ë¡œ ê²½ê³ ë§Œ í‘œì‹œ
            }

            status.innerText = "âœ… ì—…ë¡œë“œ ì„±ê³µ!";
            selectedFile = null;
            document.getElementById('uploadBtn').style.display = 'none';
            document.getElementById('selectedFileName').innerText = "";
            
            // ì—…ë¡œë“œ ì„±ê³µ í›„ ëª©ë¡ ê°±ì‹ 
            setTimeout(() => listFiles(), 500); 

        } catch (error) {
            console.error("ìƒì„¸ ì—ëŸ¬:", error);
            status.innerText = `âŒ ì‹¤íŒ¨: ${error.message}`;
        }
    }

    // ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜: ì›ë³¸ íŒŒì¼ëª…(ë‚ ì§œ ì œì™¸)ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œ
    async function downloadFile(safeFileName, originalFileName) {
        try {
            const { data, error } = await _supabase.storage
                .from('excel-files')
                .download(`${tableName}/${safeFileName}`);
            
            if (error) throw error;
            
            // íŒŒì¼ëª…ì—ì„œ ë‚ ì§œ ë¶€ë¶„(--YYYYMMDD) ì œê±°
            const downloadFileName = originalFileName.replace(/--\d{8}(?=\.[^.]+)?$/, '');
            
            // Blobì„ ë‹¤ìš´ë¡œë“œ ë§í¬ë¡œ ë³€í™˜
            const url = window.URL.createObjectURL(data);
            const a = document.createElement('a');
            a.href = url;
            a.download = downloadFileName; // ë‚ ì§œê°€ ì œê±°ëœ ì›ë³¸ íŒŒì¼ëª…ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œ
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        } catch (error) {
            console.error("ë‹¤ìš´ë¡œë“œ ì—ëŸ¬:", error);
            alert(`ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ${error.message}`);
        }
    }

    // ì´ˆê¸° ì‹¤í–‰
    window.onload = () => {
        if(window.location.hash === '#upload') showSection('upload');
    };
</script>
</body>
</html>
